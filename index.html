<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم بيانات المعلمين</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap');
        body { font-family: 'Tajawal', sans-serif; background-color: #f0f2f5; }
        .main-tab-btn.active { border-color: #3b82f6; color: #3b82f6; background-color: white; }
        .sub-tab-btn.active { color: #3b82f6; border-color: #3b82f6; }
        #edit-modal { backdrop-filter: blur(5px); }
    </style>
</head>
<body class="text-gray-800">

    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 z-50 flex justify-center items-center">
        <div class="bg-white rounded-lg shadow-xl p-8 w-11/12 md:w-96 text-center">
            <i class="fas fa-shield-alt text-5xl text-blue-500 mb-4"></i>
            <h3 class="text-2xl font-bold mb-4">تسجيل الدخول للوحة التحكم</h3>
            <form id="login-form">
                <input type="password" id="password-input" placeholder="أدخل كلمة المرور" class="w-full p-3 mb-4 border border-gray-300 rounded-lg text-center" required>
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition">دخول</button>
            </form>
        </div>
    </div>

    <!-- Main Content -->
    <div id="main-content" class="container mx-auto p-4 sm:p-6 lg:p-8 hidden">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-700">لوحة تحكم بيانات المعلمين</h1>
            <p class="text-gray-500 mt-1">عرض وإدارة البيانات حسب نوع المدرسة</p>
        </header>

        <!-- Main Tabs -->
        <div class="flex justify-center mb-6">
            <div class="inline-flex rounded-lg shadow-sm bg-gray-200 p-1">
                <button id="main-tab-gov" class="main-tab-btn active px-6 py-2 text-sm font-medium rounded-md">المدارس الحكومية</button>
                <button id="main-tab-private" class="main-tab-btn px-6 py-2 text-sm font-medium rounded-md">المدارس الخاصة</button>
            </div>
        </div>

        <!-- Content for Government Schools -->
        <div id="content-gov" class="main-tab-content">
            <div class="bg-white p-6 rounded-2xl shadow-lg">
                <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                    <div class="border-b md:border-b-0 md:border-l md:pl-4 border-gray-200">
                        <nav class="-mb-px flex space-x-6">
                            <button data-type="gov" data-view="table" class="sub-tab-btn active py-3 px-1 border-b-2 font-medium text-sm">جدول البيانات</button>
                            <button data-type="gov" data-view="whatsapp" class="sub-tab-btn text-gray-500 py-3 px-1 border-b-2 font-medium text-sm">مرسل الواتساب</button>
                        </nav>
                    </div>
                    <div class="flex items-center gap-4">
                        <select id="sort-gov" class="form-select bg-white border border-gray-300 rounded-lg p-2 text-sm">
                            <option value="newest">الأحدث أولاً</option>
                            <option value="alpha">ترتيب أبجدي بالاسم</option>
                            <option value="schoolAlpha">ترتيب أبجدي بالمدرسة</option>
                        </select>
                         <button id="export-gov-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition text-sm">
                            <i class="fas fa-file-excel mr-2"></i>تصدير Excel
                        </button>
                        <div class="bg-blue-50 p-3 rounded-lg text-center">
                            <p class="text-sm text-blue-600">إجمالي</p>
                            <p id="count-gov" class="text-2xl font-bold text-blue-700">0</p>
                        </div>
                    </div>
                </div>
                <div data-type="gov" data-view="table" class="sub-tab-content">
                    <div class="overflow-x-auto">
                        <table id="table-gov" class="min-w-full bg-white"><thead class="bg-gray-100"><tr></tr></thead><tbody></tbody></table>
                    </div>
                </div>
                <div data-type="gov" data-view="whatsapp" class="sub-tab-content hidden">
                    <div id="whatsapp-list-gov" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 pt-4"></div>
                </div>
            </div>
        </div>

        <!-- Content for Private Schools -->
        <div id="content-private" class="main-tab-content hidden">
            <div class="bg-white p-6 rounded-2xl shadow-lg">
                 <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                    <div class="border-b md:border-b-0 md:border-l md:pl-4 border-gray-200">
                        <nav class="-mb-px flex space-x-6">
                            <button data-type="private" data-view="table" class="sub-tab-btn active py-3 px-1 border-b-2 font-medium text-sm">جدول البيانات</button>
                            <button data-type="private" data-view="whatsapp" class="sub-tab-btn text-gray-500 py-3 px-1 border-b-2 font-medium text-sm">مرسل الواتساب</button>
                        </nav>
                    </div>
                     <div class="flex items-center gap-4">
                        <select id="sort-private" class="form-select bg-white border border-gray-300 rounded-lg p-2 text-sm">
                            <option value="newest">الأحدث أولاً</option>
                            <option value="alpha">ترتيب أبجدي بالاسم</option>
                            <option value="schoolAlpha">ترتيب أبجدي بالمدرسة</option>
                        </select>
                        <button id="export-private-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition text-sm">
                            <i class="fas fa-file-excel mr-2"></i>تصدير Excel
                        </button>
                        <div class="bg-green-50 p-3 rounded-lg text-center">
                            <p class="text-sm text-green-600">إجمالي</p>
                            <p id="count-private" class="text-2xl font-bold text-green-700">0</p>
                        </div>
                    </div>
                </div>
                <div data-type="private" data-view="table" class="sub-tab-content">
                     <div class="overflow-x-auto">
                        <table id="table-private" class="min-w-full bg-white"><thead class="bg-gray-100"><tr></tr></thead><tbody></tbody></table>
                    </div>
                </div>
                <div data-type="private" data-view="whatsapp" class="sub-tab-content hidden">
                    <div id="whatsapp-list-private" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 pt-4"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="edit-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 z-40 flex justify-center items-center hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 md:w-2/3 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center border-b pb-3 mb-5">
                <h3 class="text-2xl font-bold">تعديل بيانات المعلم</h3>
                <button id="close-modal-btn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>
            <form id="edit-form" class="grid grid-cols-1 md:grid-cols-2 gap-4"></form>
            <div class="mt-6 text-left">
                <button id="save-changes-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition">حفظ التعديلات</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyC-TbgJ65PuKeiedsTBjhpOvuV0uTg95kA",
            authDomain: "teacher-data-collection-716bb.firebaseapp.com",
            projectId: "teacher-data-collection-716bb",
            storageBucket: "teacher-data-collection-716bb.appspot.com",
            messagingSenderId: "265119186663",
            appId: "1:265119186663:web:6703a0600f0de0f93b2c42",
            measurementId: "G-376PKG2V6M"
        };
        const ADMIN_PASSWORD = "admin";

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const loginModal = document.getElementById('login-modal');
        const mainContent = document.getElementById('main-content');
        const loginForm = document.getElementById('login-form');
        const passwordInput = document.getElementById('password-input');
        const editModal = document.getElementById('edit-modal');
        const editForm = document.getElementById('edit-form');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const saveChangesBtn = document.getElementById('save-changes-btn');
        const sortGovSelect = document.getElementById('sort-gov');
        const sortPrivateSelect = document.getElementById('sort-private');
        
        let allTeachersData = [], governmentTeachersData = [], privateTeachersData = [];
        let currentEditingId = null;

        const allHeaders = [
            "نوع المدرسة", "المدرسة", "الصفوف", "اسم المعلم", "عدد الحصص", "الصفوف التي يدرسها", "التخصص", "الهاتف", "الجنسية", "المؤهل", "الحالة الاجتماعية", "اللغة التي يتم تدريس بها المادة", "اسم مدير المدرسة", "هاتف مدير المدرسة", "المنهاج", "التقويم", "رياضة (11)", "رياضة (12)", "الموافقة على التعيين", "موقع المدرسة", "هاتف آخر للمدرسة",
            "عدد معلمي الرياضة", "رقم الملف", "الفصول التي تدرسها", "السكن الحالي", "سنة التعيين", "الدرجة المالية", "الرقم المدني", "الجامعة", "تاريخ الميلاد", "العنوان الدائم", "البريد الالكتروني"
        ];

        // --- Login Logic ---
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (passwordInput.value === ADMIN_PASSWORD) {
                loginModal.classList.add('hidden');
                mainContent.classList.remove('hidden');
                listenForData();
            }
        });

        // --- Tab Logic ---
        const mainTabButtons = document.querySelectorAll('.main-tab-btn');
        const mainTabContents = document.querySelectorAll('.main-tab-content');
        mainTabButtons.forEach(button => {
            button.addEventListener('click', () => {
                mainTabButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                const targetId = button.id.replace('main-tab-', 'content-');
                mainTabContents.forEach(content => content.classList.toggle('hidden', content.id !== targetId));
            });
        });

        const subTabButtons = document.querySelectorAll('.sub-tab-btn');
        subTabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const type = button.dataset.type;
                const view = button.dataset.view;
                document.querySelectorAll(`.sub-tab-btn[data-type="${type}"]`).forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                document.querySelectorAll(`.sub-tab-content[data-type="${type}"]`).forEach(content => {
                    content.classList.toggle('hidden', content.dataset.view !== view);
                });
            });
        });
        
        // --- Sorting and Rendering ---
        function applySortingAndRender() {
            const sortGovBy = sortGovSelect.value;
            let sortedGov = [...governmentTeachersData];
            if (sortGovBy === 'alpha') {
                sortedGov.sort((a, b) => (a.data['اسم المعلم'] || a.data['اسم المعلم الثلاثي'] || '').localeCompare(b.data['اسم المعلم'] || b.data['اسم المعلم الثلاثي'] || '', 'ar'));
            } else if (sortGovBy === 'schoolAlpha') {
                sortedGov.sort((a, b) => (a.data['المدرسة'] || '').localeCompare(b.data['المدرسة'] || '', 'ar'));
            } else { 
                sortedGov.reverse();
            }

            const sortPrivateBy = sortPrivateSelect.value;
            let sortedPrivate = [...privateTeachersData];
             if (sortPrivateBy === 'alpha') {
                sortedPrivate.sort((a, b) => (a.data['اسم المعلم'] || a.data['اسم المعلم الثلاثي'] || '').localeCompare(b.data['اسم المعلم'] || b.data['اسم المعلم الثلاثي'] || '', 'ar'));
            } else if (sortPrivateBy === 'schoolAlpha') {
                sortedPrivate.sort((a, b) => (a.data['المدرسة'] || '').localeCompare(b.data['المدرسة'] || '', 'ar'));
            } else {
                sortedPrivate.reverse();
            }

            renderSection('gov', sortedGov);
            renderSection('private', sortedPrivate);
        }

        function renderSection(type, teachers) {
            document.getElementById(`count-${type}`).textContent = teachers.length;
            renderTableView(type, teachers);
            renderWhatsappView(type, teachers);
        }

        function renderTableView(type, teachers) {
            const table = document.getElementById(`table-${type}`);
            const thead = table.querySelector('thead tr');
            const tbody = table.querySelector('tbody');
            thead.innerHTML = '';
            tbody.innerHTML = '';

            const displayHeaders = ["اسم المعلم", "المدرسة", "الهاتف", "الرقم المدني"];
            displayHeaders.forEach(h => thead.appendChild(Object.assign(document.createElement('th'), { className: 'px-6 py-3 text-right text-xs font-bold text-gray-600 uppercase', textContent: h })));
            thead.appendChild(Object.assign(document.createElement('th'), { className: 'px-6 py-3 text-center text-xs font-bold text-gray-600 uppercase', textContent: 'إجراءات' }));
        
            teachers.forEach(teacher => {
                const row = tbody.insertRow();
                row.className = 'border-b hover:bg-gray-50';
                
                const nameCell = row.insertCell();
                nameCell.className = 'px-6 py-4 whitespace-nowrap';
                nameCell.textContent = teacher.data["اسم المعلم الثلاثي"] || teacher.data["اسم المعلم"] || '-';

                const schoolCell = row.insertCell();
                schoolCell.className = 'px-6 py-4 whitespace-nowrap';
                schoolCell.textContent = teacher.data["المدرسة"] || '-';

                const phoneCell = row.insertCell();
                phoneCell.className = 'px-6 py-4 whitespace-nowrap';
                phoneCell.textContent = teacher.data["الهاتف"] || teacher.data["هاتف المعلم"] || '-';

                const civilIdCell = row.insertCell();
                civilIdCell.className = 'px-6 py-4 whitespace-nowrap';
                civilIdCell.textContent = teacher.data["الرقم المدني"] || '-';

                const actionCell = row.insertCell();
                actionCell.className = 'px-6 py-4 whitespace-nowrap text-center space-x-4';
                
                const editBtn = Object.assign(document.createElement('button'), { innerHTML: `<i class="fas fa-edit"></i>`, className: 'text-blue-500 hover:text-blue-700 transition', title: 'تعديل', onclick: () => openEditModal(teacher) });
                const deleteBtn = Object.assign(document.createElement('button'), { innerHTML: `<i class="fas fa-trash-alt"></i>`, className: 'text-red-500 hover:text-red-700 transition', title: 'حذف', onclick: () => deleteTeacher(teacher.id) });
                
                actionCell.append(editBtn, deleteBtn);
            });
        }

        function renderWhatsappView(type, teachers) {
            const list = document.getElementById(`whatsapp-list-${type}`);
            list.innerHTML = '';
            teachers.forEach(teacher => {
                const card = document.createElement('div');
                card.className = 'bg-gray-50 p-4 rounded-lg border';
                card.innerHTML = `
                    <h3 class="font-bold text-lg text-gray-800">${teacher.data["اسم المعلم الثلاثي"] || teacher.data["اسم المعلم"]}</h3>
                    <p class="text-gray-500 mb-4">${teacher.data["هاتف المعلم"] || teacher.data["الهاتف"] || 'لا يوجد رقم هاتف'}</p>
                    <button data-id="${teacher.id}" class="send-whatsapp-btn w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition flex items-center justify-center">
                        <i class="fab fa-whatsapp mr-2"></i> إرسال بيانات
                    </button>
                `;
                list.appendChild(card);
            });
        }
        
        // --- Data Fetching ---
        function listenForData() {
            onSnapshot(collection(db, "teachers"), (snapshot) => {
                allTeachersData = snapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));
                
                governmentTeachersData = allTeachersData.filter(t => t.data["نوع المدرسة"] === "حكومية");
                privateTeachersData = allTeachersData.filter(t => t.data["نوع المدرسة"] === "خاصة");

                applySortingAndRender();
            });
        }
        
        // --- Event Listeners & Actions ---
        sortGovSelect.addEventListener('change', applySortingAndRender);
        sortPrivateSelect.addEventListener('change', applySortingAndRender);

        document.addEventListener('click', (e) => {
            if (e.target.closest('.send-whatsapp-btn')) {
                const teacherId = e.target.closest('.send-whatsapp-btn').dataset.id;
                const teacher = allTeachersData.find(t => t.id === teacherId);
                if (teacher) sendWhatsAppMessage(teacher);
            }
        });
        
        document.getElementById('export-gov-btn').addEventListener('click', () => exportToExcel('الحكومية', governmentTeachersData));
        document.getElementById('export-private-btn').addEventListener('click', () => exportToExcel('الخاصة', privateTeachersData));

        closeModalBtn.addEventListener('click', () => editModal.classList.add('hidden'));

        saveChangesBtn.addEventListener('click', async () => {
            const formData = new FormData(editForm);
            const updatedData = {};
            for (let [key, value] of formData.entries()) {
                updatedData[key] = value;
            }

            try {
                await updateDoc(doc(db, "teachers", currentEditingId), updatedData);
                editModal.classList.add('hidden');
                alert('تم حفظ التعديلات بنجاح.');
            } catch (error) {
                console.error("Error updating document: ", error);
                alert('حدث خطأ أثناء حفظ التعديلات.');
            }
        });

        // --- Helper Functions ---
        async function deleteTeacher(id) {
            if (confirm('هل أنت متأكد من رغبتك في حذف هذا السجل؟ لا يمكن التراجع عن هذا الإجراء.')) {
                try {
                    await deleteDoc(doc(db, "teachers", id));
                    alert('تم حذف السجل بنجاح.');
                } catch (error) {
                    console.error("Error deleting document: ", error);
                    alert('حدث خطأ أثناء الحذف.');
                }
            }
        }

        function openEditModal(teacher) {
            currentEditingId = teacher.id;
            editForm.innerHTML = '';
            
            allHeaders.forEach(key => {
                if (teacher.data.hasOwnProperty(key)) {
                    const value = teacher.data[key] || '';
                    const container = document.createElement('div');
                    if (key.length > 20) container.className = 'md:col-span-2';

                    const label = Object.assign(document.createElement('label'), { className: 'block mb-1 font-medium text-sm text-gray-600', textContent: key });
                    const input = Object.assign(document.createElement('input'), { name: key, type: 'text', className: 'w-full p-2 border border-gray-300 rounded-md', value: value });
                    
                    container.append(label, input);
                    editForm.appendChild(container);
                }
            });
            editModal.classList.remove('hidden');
        }

        function sendWhatsAppMessage(teacher) {
            let phoneNumber = (teacher.data["هاتف المعلم"] || teacher.data["الهاتف"] || '').replace(/[\s+-]/g, '');
            if (!phoneNumber) return alert('لا يوجد رقم هاتف مسجل.');
            
            let message = `*بيانات المعلم: ${teacher.data["اسم المعلم الثلاثي"] || teacher.data["اسم المعلم"]}*\n\n`;
            Object.entries(teacher.data).forEach(([key, value]) => {
                 message += `*${key}:* ${value || '-'}\n`;
            });

            window.open(`https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`, '_blank');
        }

        function exportToExcel(type, data) {
            if (data.length === 0) {
                alert(`لا توجد بيانات لتصديرها للمدارس ${type}.`);
                return;
            }
            const dataToExport = data.map(teacher => teacher.data);
            const ws = XLSX.utils.json_to_sheet(dataToExport);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, `بيانات المعلمين (${type})`);
            XLSX.writeFile(wb, `قاعدة_بيانات_المدارس_${type}.xlsx`);
        }

    </script>
</body>
</html>
